Day 10ï¼šAzure DNS ä¸ Private Endpointï¼ˆç§æœ‰è®¿é—®ä¸å®‰å…¨é€šä¿¡ï¼‰
æ¨¡å—	å†…å®¹
ä¸»é¢˜	Azure DNSã€Private Endpoint
å­¦ä¹ ç›®æ ‡	ç†è§£ Azure ä¸­çš„ç§æœ‰è®¿é—®æœºåˆ¶ä¸ DNS è§£æåŸç†ï¼›æŒæ¡é€šè¿‡ Private Endpoint é…ç½®å­˜å‚¨æœåŠ¡çš„å®‰å…¨é€šä¿¡ã€‚
å®æˆ˜ä»»åŠ¡	åˆ›å»º Private Endpointï¼Œå°† Storage è´¦æˆ·æ¥å…¥ä¸“ç”¨è™šæ‹Ÿç½‘ç»œï¼›é…ç½® Azure Private DNS å®ç°ç§æœ‰è§£æä¸å®‰å…¨è®¿é—®ã€‚
ğŸ§  ä¸€ã€æ ¸å¿ƒçŸ¥è¯†è®²è§£
1. ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ Private Endpointï¼Ÿ

é»˜è®¤æƒ…å†µä¸‹ï¼ŒAzure æœåŠ¡ï¼ˆStorageã€SQLã€WebApp ç­‰ï¼‰é€šè¿‡å…¬ç½‘è®¿é—®ï¼š

https://mystorage.blob.core.windows.net/


è¿™ç§è®¿é—®æ–¹å¼è™½ç„¶å—èº«ä»½è®¤è¯ä¿æŠ¤ï¼Œä½†ä»ç»è¿‡å…¬ç½‘ IPï¼Œæœ‰æ½œåœ¨çš„å®‰å…¨é£é™©ã€‚

Private Endpoint å…è®¸ä½ åœ¨ VNet å†…åˆ›å»ºä¸€ä¸ªç§æœ‰ IP åœ°å€ï¼Œ
ä¸ Azure æœåŠ¡ç§ä¸‹é€šä¿¡ï¼ˆæµé‡ä¸å†ç»è¿‡å…¬ç½‘ï¼‰ï¼Œä»è€Œå®ç°ï¼š

æ›´å®‰å…¨çš„æ•°æ®è®¿é—®ï¼›

é›¶ä¿¡ä»»æ¶æ„ï¼›

æ›´æ˜“åˆè§„ï¼ˆGDPRã€é‡‘èè¡Œä¸šç­‰ï¼‰ï¼›

å‡å°‘æš´éœ²é¢ï¼ˆPublic Network Access å¯ç¦ç”¨ï¼‰ã€‚

2. Azure Private Link ä¸ Private Endpoint çš„å…³ç³»
æ¦‚å¿µ	è¯´æ˜	ç¤ºä¾‹
Private Link	Azure æœåŠ¡çš„ç§æœ‰åŒ–è®¿é—®æ¡†æ¶	Azure Storageã€SQLã€App Service ç­‰
Private Endpoint	ç§æœ‰ç½‘ç»œä¸­å®é™…çš„ç§æœ‰æ¥å…¥ç‚¹ (Private IP)	10.0.1.4
Private DNS Zone	å°†æœåŠ¡åŸŸåè§£æåˆ°ç§æœ‰ IP	mystorage.privatelink.blob.core.windows.net â†’ 10.0.1.4

ğŸ’¡ä¸‰è€…ç»„åˆï¼š

    Storage Account
        â”‚
    Private Link
        â”‚
    Private Endpoint (VNet å†…éƒ¨ IP)
        â”‚
    Private DNS Zone (å†…éƒ¨è§£æ)

3. Azure DNS çš„ç±»å‹ä¸ç”¨é€”
DNS ç±»å‹	è¯´æ˜	é€‚ç”¨åœºæ™¯
Public DNS Zone	å…¬å¼€è§£ææœåŠ¡	å¯¹å¤–ç½‘ç«™
Private DNS Zone	ä»…åœ¨ç‰¹å®š VNet å†…è§£æ	å†…éƒ¨ç³»ç»Ÿã€ç§æœ‰é“¾æ¥
Custom DNS Server	è‡ªå»º DNS æœåŠ¡å™¨	ä¼ä¸šæ··åˆäº‘ã€è‡ªå®šä¹‰è§£æé€»è¾‘

ğŸ’¡ Private DNS Zone å¸¸é…åˆ Private Endpoint ä¸€èµ·ä½¿ç”¨ï¼Œè‡ªåŠ¨è§£æåˆ°ç§æœ‰ IPã€‚

ğŸ§° äºŒã€å®æˆ˜ä»»åŠ¡
ä»»åŠ¡ 1ï¼šå‡†å¤‡ç¯å¢ƒ

åˆ›å»ºèµ„æºç»„ä¸è™šæ‹Ÿç½‘ç»œï¼š

az group create --name dns-lab-rg --location eastus

az network vnet create \
  --resource-group dns-lab-rg \
  --name dns-vnet \
  --address-prefix 10.0.0.0/16 \
  --subnet-name default \
  --subnet-prefix 10.0.1.0/24

ä»»åŠ¡ 2ï¼šåˆ›å»ºå­˜å‚¨è´¦æˆ·
az storage account create \
  --name mystoragepe$RANDOM \
  --resource-group dns-lab-rg \
  --location eastus \
  --sku Standard_LRS \
  --kind StorageV2 \
  --public-network-access Enabled


éªŒè¯è®¿é—®æ–¹å¼ï¼š

az storage account show --name mystoragepe123 --query "primaryEndpoints.blob"


ğŸ‘‰ è¿”å›ç±»ä¼¼ï¼š

https://mystoragepe123.blob.core.windows.net/

ä»»åŠ¡ 3ï¼šåˆ›å»º Private Endpoint
az network private-endpoint create \
  --name pe-storage \
  --resource-group dns-lab-rg \
  --vnet-name dns-vnet \
  --subnet default \
  --private-connection-resource-id $(az storage account show --name mystoragepe123 --query id -o tsv) \
  --group-id blob \
  --connection-name pe-storage-conn


æ­¤æ—¶ Azure ä¼šåœ¨ dns-vnet çš„å­ç½‘å†…åˆ†é…ä¸€ä¸ªç§æœ‰ IPï¼ˆä¾‹å¦‚ 10.0.1.5ï¼‰ã€‚

ä»»åŠ¡ 4ï¼šåˆ›å»º Private DNS Zone å¹¶é“¾æ¥è™šæ‹Ÿç½‘ç»œ

åˆ›å»ºç§æœ‰ DNS åŒºåŸŸï¼š

az network private-dns zone create \
  --resource-group dns-lab-rg \
  --name privatelink.blob.core.windows.net


å°† VNet ä¸ç§æœ‰ DNS Zone å…³è”ï¼š

az network private-dns link vnet create \
  --resource-group dns-lab-rg \
  --zone-name privatelink.blob.core.windows.net \
  --name dnslink-dns-vnet \
  --virtual-network dns-vnet \
  --registration-enabled false


å°† Private Endpoint æ³¨å†Œåˆ°è¯¥ Zoneï¼š

az network private-endpoint dns-zone-group create \
  --resource-group dns-lab-rg \
  --endpoint-name pe-storage \
  --name pe-storage-zone \
  --private-dns-zone privatelink.blob.core.windows.net

ä»»åŠ¡ 5ï¼šéªŒè¯ç§æœ‰è®¿é—®ç”Ÿæ•ˆ

æŸ¥çœ‹ç§æœ‰ IPï¼š

az network private-endpoint show \
  --name pe-storage \
  --resource-group dns-lab-rg \
  --query "networkInterfaces[0].ipConfigurations[0].privateIPAddress" \
  -o tsv


è§£æåŸŸåï¼š

nslookup mystoragepe123.blob.core.windows.net


âœ… å¦‚æœè¿”å› 10.0.x.x ç§æœ‰åœ°å€ï¼Œè¯´æ˜ç§æœ‰è§£æå·²ç”Ÿæ•ˆã€‚

ä»»åŠ¡ 6ï¼šç¦ç”¨å…¬ç½‘è®¿é—®
az storage account update \
  --name mystoragepe123 \
  --public-network-access Disabled


ç°åœ¨è¯¥å­˜å‚¨åªèƒ½ä»ä½ çš„è™šæ‹Ÿç½‘ç»œï¼ˆé€šè¿‡ Private Endpointï¼‰è®¿é—®ã€‚
ä»å…¶ä»–å…¬ç½‘ç¯å¢ƒè®¿é—®ä¼šè¿”å› 403 Forbiddenã€‚

ğŸ§© ä¸‰ã€éªŒè¯æˆæœ

âœ… ä½ åº”èƒ½å®Œæˆï¼š

æˆåŠŸåˆ›å»º Storage Accountï¼›

åˆ›å»º Private Endpoint å¹¶è·å¾—ç§æœ‰ IPï¼›

å»ºç«‹ Private DNS Zoneï¼Œå®ç°åŸŸåç§æœ‰è§£æï¼›

ç¦ç”¨ Storage å…¬ç½‘è®¿é—®ï¼Œä»…é™å†…éƒ¨ç§æœ‰è®¿é—®ï¼›

åœ¨è™šæ‹Ÿæœºä¸­é€šè¿‡ç§æœ‰ IP å®‰å…¨è®¿é—® Blob æ–‡ä»¶ã€‚

ğŸ§  å››ã€å»¶ä¼¸ä¸æ€è€ƒ

ç§æœ‰è®¿é—®å¸¸è§åº”ç”¨

å†…éƒ¨ç³»ç»Ÿè®¿é—® Storageã€SQLã€Key Vaultï¼›

åº”ç”¨å±‚ï¼ˆApp Serviceï¼‰ä¸åç«¯æ•°æ®åº“é—´é€šä¿¡ï¼›

å®ç°é›¶ä¿¡ä»»ç½‘ç»œè®¿é—®ã€‚

Hub-Spoke æ¨¡å¼ä¸‹ DNS è®¾è®¡

å°† Private DNS éƒ¨ç½²åœ¨ Hubï¼›

Spoke ç½‘ç»œé€šè¿‡ Peering å…±äº«è§£æï¼›

ç¡®ä¿å¯ç”¨ DNS è½¬å‘ã€‚

Private Endpoint çš„å®‰å…¨å¼ºåŒ–

ä½¿ç”¨ NSG æ§åˆ¶å­ç½‘æµé‡ï¼›

å¯ç”¨ Defender for Storageï¼›

å¯ç”¨ä¸“ç”¨çš„é˜²ç«å¢™ç­–ç•¥ï¼›

å»ºç«‹ Tag æ ‡å‡†ï¼ˆnetwork=privateï¼‰ã€‚

æ€§èƒ½ä¸æˆæœ¬

Private Endpoint æœ¬èº«å…è´¹ï¼›

æµé‡è®¡è´¹ä¸ºå†…éƒ¨ VNet ä¼ è¾“ï¼›

æ¨èç»“åˆ Private Link Service æ‰©å±•åˆ°è‡ªå»º PaaSã€‚

ğŸ“˜ ä»Šæ—¥æ€»ç»“

ä½ æŒæ¡äº† Azure DNS ä¸ Private Endpoint çš„å·¥ä½œåŸç†ï¼›

ç†è§£äº†å¦‚ä½•å®ç° Azure æœåŠ¡çš„ç§æœ‰åŒ–è®¿é—®ï¼›

å­¦ä¼šäº†åˆ›å»º Private DNS Zone å¹¶å®ç°ç§æœ‰è§£æï¼›

æˆåŠŸéªŒè¯äº†å®‰å…¨è®¿é—® Storage çš„é…ç½®ï¼›

æŒæ¡äº†ä¼ä¸šçº§å®‰å…¨ç½‘ç»œçš„æ ¸å¿ƒæŠ€æœ¯ï¼šç§æœ‰è®¿é—® + å†…éƒ¨è§£æ + é›¶ä¿¡ä»»é˜²æŠ¤ã€‚